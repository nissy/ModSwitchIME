# ModSwitchIME ãƒã‚°ä¿®æ­£é …ç›®

## æ¦‚è¦
ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€2025å¹´6æœˆ27æ—¥ã«å®Ÿæ–½ã—ãŸç·åˆã‚·ã‚¹ãƒ†ãƒ ç›£æŸ»ã§ç™ºè¦‹ã•ã‚ŒãŸè¨­è¨ˆæ¬ é™¥ã¨ãƒã‚°ä¿®æ­£é …ç›®ã‚’è©³ç´°ã«è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚ä¿®æ­£é …ç›®ã¯å„ªå…ˆåº¦åˆ¥ã«åˆ†é¡ã•ã‚Œã€å…·ä½“çš„ãªãƒ•ã‚¡ã‚¤ãƒ«åãƒ»è¡Œç•ªå·ã¨ä¿®æ­£æ–¹æ³•ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚

## ğŸ“Š ä¿®æ­£é …ç›®ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | é‡å¤§ | ä¸­ç¨‹åº¦ | è»½å¾® | åˆè¨ˆ | ä¿®æ­£æ¸ˆã¿ |
|---------|-----|-------|-----|------|----------|
| MenuBarApp | 6 | 4 | 0 | 10 | 1 |
| KeyMonitor | 5 | 3 | 0 | 8 | 0 |
| ImeController | 6 | 4 | 0 | 10 | 2 |
| ãƒ¡ãƒ¢ãƒªãƒ»ãƒªã‚½ãƒ¼ã‚¹ç®¡ç† | 5 | 2 | 1 | 8 | 1 |
| ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ | 5 | 0 | 0 | 5 | 1 |
| ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° | 4 | 0 | 0 | 4 | 0 |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | 5 | 0 | 0 | 5 | 0 |

**åˆè¨ˆ**: 36ä»¶ã®é‡å¤§å•é¡Œã€13ä»¶ã®ä¸­ç¨‹åº¦å•é¡Œã€1ä»¶ã®è»½å¾®å•é¡Œ  
**ä¿®æ­£æ¸ˆã¿**: 5ä»¶ã®é‡å¤§å•é¡Œï¼ˆImeControlleré‡è¤‡ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç«¶åˆï¼‰

---

## ğŸš¨ é‡å¤§å•é¡Œï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

### 1. MenuBarAppè¨­è¨ˆæ¬ é™¥

#### 1.1 ImeControlleré‡è¤‡ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ âœ… **ä¿®æ­£å®Œäº†**
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `MenuBarApp.swift:109`, `KeyMonitor.swift`
- **å•é¡Œ**: MenuBarAppã¨KeyMonitorãŒãã‚Œãã‚Œç‹¬è‡ªã®ImeControllerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
- **ä¿®æ­£å†…å®¹**: 
  - ImeControllerã‚’ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¤‰æ›´ï¼ˆ`static let shared = ImeController()`ï¼‰
  - KeyMonitorã«ä¾å­˜æ€§æ³¨å…¥ã‚’å®Ÿè£…
  - ãƒ†ã‚¹ãƒˆç”¨ã«`createForTesting()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ï¼ˆDEBUGç’°å¢ƒã®ã¿ï¼‰
- **å½±éŸ¿**: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹
- **ä¿®æ­£æ—¥**: 2025-06-27

#### 1.2 å˜ä¸€è²¬ä»»åŸå‰‡ï¼ˆSRPï¼‰é•å
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `MenuBarApp.swift:1-200`
- **å•é¡Œ**: UIç®¡ç†ã€ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã€è¨­å®šç®¡ç†ã€æ¨©é™ç®¡ç†ã‚’ä¸€ã¤ã®ã‚¯ãƒ©ã‚¹ã§å®Ÿè£…
- **ç¾åœ¨ã®è²¬ä»»**:
  - NSStatusItemç®¡ç†
  - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æ¨©é™ãƒã‚§ãƒƒã‚¯
  - KeyMonitoråˆ¶å¾¡
  - IMEçŠ¶æ…‹ç›£è¦–
  - è¨­å®šã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¡¨ç¤º
- **æ¨å¥¨ä¿®æ­£**:
  ```swift
  // åˆ†é›¢æ¡ˆ
  class MenuBarController: NSObject {
      private let statusItemManager: StatusItemManager
      private let keyboardManager: KeyboardManager
      private let permissionManager: PermissionManager
  }
  ```

#### 1.3 ä¾å­˜é–¢ä¿‚æ³¨å…¥ã®ä¸å‚™
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `MenuBarApp.swift:12-21`
- **å•é¡Œ**: å…·è±¡ã‚¯ãƒ©ã‚¹ã«ç›´æ¥ä¾å­˜ã€ãƒ†ã‚¹ãƒˆå›°é›£
- **ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰**:
  ```swift
  private var keyMonitor: KeyMonitor?
  private lazy var imeController = ImeController()
  ```
- **æ¨å¥¨ä¿®æ­£**:
  ```swift
  protocol IMEControlling {
      func getCurrentInputSource() -> String
      func switchToSpecificIME(_ imeId: String)
  }
  private let imeController: IMEControlling
  ```

#### 1.4 çŠ¶æ…‹ç®¡ç†ã®éåŒæœŸä¸æ•´åˆ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `MenuBarApp.swift:150-170`
- **å•é¡Œ**: ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ãŒéåŒæœŸã§ä¸æ•´åˆ
- **ä¿®æ­£æ–¹æ³•**: çŠ¶æ…‹ç®¡ç†ã‚’ObservableObjectãƒ‘ã‚¿ãƒ¼ãƒ³ã«çµ±ä¸€

#### 1.5 åˆæœŸåŒ–é †åºã®ä¾å­˜é–¢ä¿‚å•é¡Œ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `MenuBarApp.swift:25-45`
- **å•é¡Œ**: KeyMonitoråˆæœŸåŒ–å‰ã«IMEçŠ¶æ…‹ç›£è¦–ã‚’é–‹å§‹
- **ä¿®æ­£æ–¹æ³•**: ä¾å­˜é–¢ä¿‚ã‚’æ˜ç¢ºåŒ–ã—ã€åˆæœŸåŒ–é †åºã‚’ä¿®æ­£

#### 1.6 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®åˆ†æ•£
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `MenuBarApp.swift:å…¨ä½“`
- **å•é¡Œ**: ã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒå„ãƒ¡ã‚½ãƒƒãƒ‰ã«åˆ†æ•£ã€ä¸€è²«æ€§ãªã—
- **ä¿®æ­£æ–¹æ³•**: çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥ã‚’å®Ÿè£…

### 2. KeyMonitorè¨­è¨ˆæ¬ é™¥

#### 2.1 CGEventTapã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…é‡å‡¦ç†
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:153-329`
- **å•é¡Œ**: ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†å†…ã§IMEåˆ‡ã‚Šæ›¿ãˆã‚’åŒæœŸå®Ÿè¡Œ
- **ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰**:
  ```swift
  private func handleEvent(proxy: CGEventTapProxy, type: CGEventType, event: CGEvent) -> Unmanaged<CGEvent>? {
      // é‡ã„å‡¦ç†ãŒã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§å®Ÿè¡Œã•ã‚Œã‚‹
      imeController.switchToSpecificIME(targetIME)
  }
  ```
- **æ¨å¥¨ä¿®æ­£**:
  ```swift
  private func handleEvent(...) -> Unmanaged<CGEvent>? {
      // è»½é‡ãªå‡¦ç†ã®ã¿
      DispatchQueue.main.async { [weak self] in
          self?.scheduleIMESwitch(targetIME)
      }
  }
  ```

#### 2.2 è¤‡æ•°ã‚¿ã‚¤ãƒãƒ¼ã®ç«¶åˆçŠ¶æ…‹
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:39-44`
- **å•é¡Œ**: idle/retry/healthã‚¿ã‚¤ãƒãƒ¼ãŒéåŒæœŸã§ç«¶åˆ
- **ç¾åœ¨ã®ã‚¿ã‚¤ãƒãƒ¼**:
  - `idleTimer?: Timer?`
  - `retryTimer: Timer?`
  - `eventTapHealthTimer: Timer?`
- **ä¿®æ­£æ–¹æ³•**: ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†ã‚’çµ±ä¸€ã‚¯ãƒ©ã‚¹ã«é›†ç´„

#### 2.3 ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãƒ†ã‚£å•é¡Œ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:32-36`
- **å•é¡Œ**: `stateQueue.sync`ã§ã®ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯å¯èƒ½æ€§
- **ä¿®æ­£æ–¹æ³•**: actorãƒ‘ã‚¿ãƒ¼ãƒ³ã¾ãŸã¯éåŒæœŸå‡¦ç†ã«å¤‰æ›´

#### 2.4 EventTapå†ä½œæˆã®ç«¶åˆ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:501-511`
- **å•é¡Œ**: è¤‡æ•°ã®å†ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåŒæ™‚å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§
- **ä¿®æ­£æ–¹æ³•**: çŠ¶æ…‹ç®¡ç†ã«ã‚ˆã‚‹æ’ä»–åˆ¶å¾¡

#### 2.5 ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æœ€é©åŒ–ä¸å‚™
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:25-36`
- **å•é¡Œ**: keyStatesã®åŠ¹ç‡çš„ã§ãªã„æ§‹é€ ä½“ä½¿ç”¨
- **ä¿®æ­£æ–¹æ³•**: ã‚ˆã‚ŠåŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¸ã®å¤‰æ›´

### 3. ImeControllerè¨­è¨ˆæ¬ é™¥

#### 3.1 CoreFoundationãƒ¡ãƒ¢ãƒªç®¡ç†ä¸å‚™ âœ… **ä¿®æ­£å®Œäº†**
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:186-302`
- **å•é¡Œ**: `TISCreateInputSourceList`ã®æ‰‹å‹•ãƒ¡ãƒ¢ãƒªç®¡ç†ãŒä¸é©åˆ‡
- **ä¿®æ­£å†…å®¹**:
  - `takeRetainedValue()`ã‚’ä½¿ç”¨ï¼ˆè‡ªå‹•çš„ã«ãƒ¡ãƒ¢ãƒªç®¡ç†ï¼‰
  - æ‰‹å‹•CFReleaseã‚’å‰Šé™¤
  - ARCä¸‹ã§ã®é©åˆ‡ãªãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’å®Ÿè£…
- **ä¿®æ­£æ—¥**: 2025-06-27

#### 3.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç«¶åˆçŠ¶æ…‹ âœ… **ä¿®æ­£å®Œäº†**
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:11-22`
- **å•é¡Œ**: concurrent queueã§ã®æ›¸ãè¾¼ã¿æ“ä½œãŒç«¶åˆ
- **ä¿®æ­£å†…å®¹**:
  - cacheQueueã‚’`.concurrent`ã‹ã‚‰ç›´åˆ—ã‚­ãƒ¥ãƒ¼ã«å¤‰æ›´
  - ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ç”¨ã®å°‚ç”¨ç›´åˆ—ã‚­ãƒ¥ãƒ¼ã‚’è¿½åŠ 
  - ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Ÿè£…
- **ä¿®æ­£æ—¥**: 2025-06-27

#### 3.3 é€šçŸ¥ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ã®ãƒªãƒ¼ã‚¯
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:462-467`
- **å•é¡Œ**: è¤‡æ•°é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒä¸å®Œå…¨
- **ä¿®æ­£æ–¹æ³•**: å„é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼ã”ã¨ã®å€‹åˆ¥observerç®¡ç†

#### 3.4 åŒæœŸå‡¦ç†ã«ã‚ˆã‚‹UIå¿œç­”æ€§ä½ä¸‹
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:305-316`
- **å•é¡Œ**: `refreshCacheSync`ã§ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ–ãƒ­ãƒƒã‚¯
- **ä¿®æ­£æ–¹æ³•**: å®Œå…¨éåŒæœŸå‡¦ç†ã¸ã®å¤‰æ›´

#### 3.5 ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°æ©Ÿæ§‹ã®éåŠ¹ç‡æ€§
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:113-149`
- **å•é¡Œ**: ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡é›‘ã§ä¿å®ˆå›°é›£
- **ä¿®æ­£æ–¹æ³•**: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ãƒã‚¦ãƒ³ã‚¹æ©Ÿæ§‹ã¸ã®å¤‰æ›´

#### 3.6 ã‚¨ãƒ©ãƒ¼å¾©æ—§ã®ä¸å‚™
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:194-218`
- **å•é¡Œ**: ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ãŒé™å®šçš„ã€æ ¹æœ¬åŸå› å¯¾å‡¦ãªã—
- **ä¿®æ­£æ–¹æ³•**: ã‚ˆã‚Šå …ç‰¢ãªã‚¨ãƒ©ãƒ¼å¾©æ—§æˆ¦ç•¥

### 4. ãƒ¡ãƒ¢ãƒªãƒ»ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†å•é¡Œ

#### 4.1 ThreadSafetyUtilsã‚»ãƒãƒ•ã‚©ãƒªãƒ¼ã‚¯
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ThreadSafetyUtils.swift:17-31`
- **å•é¡Œ**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã«ã‚»ãƒãƒ•ã‚©ãŒé©åˆ‡ã«è§£æ”¾ã•ã‚Œãªã„
- **ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰**:
  ```swift
  if semaphore.wait(timeout: .now() + timeout) == .timedOut {
      return nil // ã‚»ãƒãƒ•ã‚©ãŒãƒªãƒ¼ã‚¯ã™ã‚‹
  }
  ```
- **æ¨å¥¨ä¿®æ­£**:
  ```swift
  let waitResult = semaphore.wait(timeout: .now() + timeout)
  defer { if waitResult == .timedOut { semaphore.signal() } }
  ```

#### 4.2 inputSourceCacheã®ç„¡åˆ¶é™æ‹¡å¼µ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:57-73`
- **å•é¡Œ**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚µã‚¤ã‚ºåˆ¶é™ãªã—
- **ä¿®æ­£æ–¹æ³•**: LRUã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¾ãŸã¯å®šæœŸçš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

#### 4.3 DistributedNotificationCenterè¦³å¯Ÿè€…ãƒªãƒ¼ã‚¯
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `MenuBarApp.swift`, `ImeController.swift`
- **å•é¡Œ**: DistributedNotificationCenterã®è¦³å¯Ÿè€…ãŒé©åˆ‡ã«å‰Šé™¤ã•ã‚Œãªã„
- **ä¿®æ­£æ–¹æ³•**: è¦³å¯Ÿè€…ã®æ˜ç¤ºçš„ãªç®¡ç†ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

#### 4.4 ã‚¿ã‚¤ãƒãƒ¼ã®å¾ªç’°å‚ç…§
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:369-374`
- **å•é¡Œ**: Timerå†…ã§ã®selfå¼·å‚ç…§
- **ä¿®æ­£æ–¹æ³•**: [weak self]ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¾¹åº•

#### 4.5 CoreFoundationã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªãƒ¼ã‚¯
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:å…¨ä½“`
- **å•é¡Œ**: CFç³»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ‰‹å‹•ç®¡ç†ãŒä¸é©åˆ‡
- **ä¿®æ­£æ–¹æ³•**: Swiftãƒ©ãƒƒãƒ‘ãƒ¼ã¾ãŸã¯è‡ªå‹•ç®¡ç†ã¸ã®ç§»è¡Œ

### 5. ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãƒ†ã‚£å•é¡Œ

#### 5.1 CGEventTapã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã®ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:153-197`
- **å•é¡Œ**: CGEventã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã®ç›¸äº’ãƒ­ãƒƒã‚¯
- **ä¿®æ­£æ–¹æ³•**: éåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã¸ã®å¤‰æ›´

#### 5.2 Combineãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ã®éåŒæœŸæ›´æ–°ç«¶åˆ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:424-445`
- **å•é¡Œ**: Preferencesã®@PublishedãŒãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ã§ç«¶åˆ
- **ä¿®æ­£æ–¹æ³•**: MainActorã¾ãŸã¯å°‚ç”¨ã‚­ãƒ¥ãƒ¼ã§ã®å‡¦ç†

#### 5.3 è¤‡æ•°DispatchQueueã®ä¾å­˜é–¢ä¿‚ä¸æ˜
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:12, 16, 22`
- **å•é¡Œ**: 3ã¤ã®ã‚­ãƒ¥ãƒ¼ã®å®Ÿè¡Œé †åºãŒä¿è¨¼ã•ã‚Œãªã„
- **ä¿®æ­£æ–¹æ³•**: ã‚­ãƒ¥ãƒ¼éšå±¤ã®æ˜ç¢ºåŒ–

#### 5.4 keyStatesã®éåŸå­çš„æ›´æ–°
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:32-36`
- **å•é¡Œ**: è¾æ›¸ã®æ›´æ–°æ“ä½œãŒéåŸå­çš„
- **ä¿®æ­£æ–¹æ³•**: actorã¾ãŸã¯NSLockã«ã‚ˆã‚‹ä¿è­·

#### 5.5 EventTapçŠ¶æ…‹ã®ç«¶åˆ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:58-151`
- **å•é¡Œ**: start/stopæ“ä½œã®ç«¶åˆçŠ¶æ…‹
- **ä¿®æ­£æ–¹æ³•**: çŠ¶æ…‹æ©Ÿæ¢°ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å°å…¥

### 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å•é¡Œ

#### 6.1 ã‚¨ãƒ©ãƒ¼å¾©æ—§æˆ¦ç•¥ã®ä¸å‚™
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ErrorHandling.swift:52-59`
- **å•é¡Œ**: é™å®šçš„ãªã‚¨ãƒ©ãƒ¼ã®ã¿è‡ªå‹•å¾©æ—§å¯¾è±¡
- **ä¿®æ­£æ–¹æ³•**: åŒ…æ‹¬çš„ãªå¾©æ—§æˆ¦ç•¥ã®å®Ÿè£…

#### 6.2 ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã®å•é¡Œ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ErrorHandling.swift:41-50`
- **å•é¡Œ**: é‡è¦ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ãŒé…å»¶
- **ä¿®æ­£æ–¹æ³•**: ã‚¨ãƒ©ãƒ¼é‡è¦åº¦ã«ã‚ˆã‚‹å³åº§é€šçŸ¥

#### 6.3 ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æå¤±
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ErrorHandling.swift:76-82`
- **å•é¡Œ**: ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãŒå¤±ã‚ã‚Œã‚‹
- **ä¿®æ­£æ–¹æ³•**: è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã®ä¿æŒ

#### 6.4 éåŒæœŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ä¸å‚™
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:515-535`
- **å•é¡Œ**: éåŒæœŸæ“ä½œä¸­ã®ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«ä¼æ’­ã•ã‚Œãªã„
- **ä¿®æ­£æ–¹æ³•**: Resultå‹ã«ã‚ˆã‚‹æ˜ç¤ºçš„ã‚¨ãƒ©ãƒ¼å‡¦ç†

### 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ

#### 7.1 åŒæœŸå‡¦ç†ã«ã‚ˆã‚‹UIå¿œç­”æ€§ä½ä¸‹
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:305-316`
- **å•é¡Œ**: ã‚»ãƒãƒ•ã‚©ã«ã‚ˆã‚‹ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ–ãƒ­ãƒƒã‚¯
- **ä¿®æ­£æ–¹æ³•**: å®Œå…¨éåŒæœŸå‡¦ç†ã¸ã®å¤‰æ›´

#### 7.2 é »ç¹ãªIMEã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:76-81`
- **å•é¡Œ**: ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥ã”ã¨ã«å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†æ§‹ç¯‰
- **ä¿®æ­£æ–¹æ³•**: å·®åˆ†æ›´æ–°æ©Ÿæ§‹ã®å®Ÿè£…

#### 7.3 éåŠ¹ç‡çš„ãªã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:359-420`
- **å•é¡Œ**: æœ€é©åŒ–ã•ã‚Œã¦ã„ãªã„é–“éš”è¨­å®š
- **ä¿®æ­£æ–¹æ³•**: å‹•çš„é–“éš”èª¿æ•´ã®å®Ÿè£…

#### 7.4 ä¸è¦ãªDispatchQueueä½œæˆ
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:12, 16, 22`
- **å•é¡Œ**: é¡ä¼¼ç›®çš„ã§è¤‡æ•°ã‚­ãƒ¥ãƒ¼ä½œæˆ
- **ä¿®æ­£æ–¹æ³•**: ã‚­ãƒ¥ãƒ¼ã®çµ±åˆã¨æœ€é©åŒ–

#### 7.5 CGEventã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…é‡å‡¦ç†
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:153-329`
- **å•é¡Œ**: ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆå†…ã§é‡ã„å‡¦ç†
- **ä¿®æ­£æ–¹æ³•**: è»½é‡ãªå‡¦ç†ã®ã¿ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§å®Ÿè¡Œ

---

## ğŸ“Š ä¸­ç¨‹åº¦å•é¡Œï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰

### MenuBarAppä¸­ç¨‹åº¦å•é¡Œ

#### M1.1 è¨­å®šã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®çŠ¶æ…‹ç®¡ç†
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `MenuBarApp.swift:85-95`
- **å•é¡Œ**: PreferencesWindowã®è¡¨ç¤ºçŠ¶æ…‹ç®¡ç†ãŒä¸å®Œå…¨
- **ä¿®æ­£æ–¹æ³•**: WindowControllerãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¡ç”¨

#### M1.2 ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æ¨©é™ãƒã‚§ãƒƒã‚¯ã®é »åº¦
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `MenuBarApp.swift:60-75`
- **å•é¡Œ**: æ¨©é™ãƒã‚§ãƒƒã‚¯ãŒéåº¦ã«é »ç¹
- **ä¿®æ­£æ–¹æ³•**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿæ§‹ã®å°å…¥

#### M1.3 ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°ã®åŠ¹ç‡æ€§
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `MenuBarApp.swift:180-200`
- **å•é¡Œ**: IMEå¤‰æ›´ã®ãŸã³ã«å…¨ã‚¢ã‚¤ã‚³ãƒ³å†æ§‹ç¯‰
- **ä¿®æ­£æ–¹æ³•**: å·®åˆ†æ›´æ–°ã®å®Ÿè£…

#### M1.4 é€šçŸ¥è¦³å¯Ÿè€…ã®é‡è¤‡ç™»éŒ²
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `MenuBarApp.swift:55-70`
- **å•é¡Œ**: åŒã˜é€šçŸ¥ã«è¤‡æ•°ã®è¦³å¯Ÿè€…ç™»éŒ²å¯èƒ½æ€§
- **ä¿®æ­£æ–¹æ³•**: é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿæ§‹

### KeyMonitorä¸­ç¨‹åº¦å•é¡Œ

#### M2.1 ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®éå‰°å‡ºåŠ›
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:250-255`
- **å•é¡Œ**: ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰ã§ã‚‚ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›
- **ä¿®æ­£æ–¹æ³•**: ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«åˆ¶å¾¡ã®å®Ÿè£…

#### M2.2 ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ãƒƒãƒ—ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®åŠ¹ç‡æ€§
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:459-498`
- **å•é¡Œ**: å›ºå®šé–“éš”ã§ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- **ä¿®æ­£æ–¹æ³•**: é©å¿œçš„é–“éš”èª¿æ•´

#### M2.3 Preferenceå¤‰æ›´ã®å³åº§åæ˜ 
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `KeyMonitor.swift:424-445`
- **å•é¡Œ**: è¨­å®šå¤‰æ›´ã®åæ˜ ã«é…å»¶
- **ä¿®æ­£æ–¹æ³•**: å³åº§æ›´æ–°æ©Ÿæ§‹ã®å®Ÿè£…

### ImeControllerä¸­ç¨‹åº¦å•é¡Œ

#### M3.1 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æ€§ã®æ¤œè¨¼ä¸è¶³
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:186-230`
- **å•é¡Œ**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸTISInputSourceã®æœ‰åŠ¹æ€§æœªç¢ºèª
- **ä¿®æ­£æ–¹æ³•**: å®šæœŸçš„ãªæœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯

#### M3.2 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç›£è¦–ã®éè² è·
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:379-417`
- **å•é¡Œ**: å…¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆã‚’ç›£è¦–
- **ä¿®æ­£æ–¹æ³•**: é–¢é€£ã‚¢ãƒ—ãƒªã®ã¿ã«é™å®š

#### M3.3 ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ã®ã‚¹ãƒãƒ¼ãƒˆåŒ–ä¸è¶³
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:194-218`
- **å•é¡Œ**: å›ºå®šçš„ãªãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥
- **ä¿®æ­£æ–¹æ³•**: ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã«ã‚ˆã‚‹é©å¿œçš„ãƒªãƒˆãƒ©ã‚¤

#### M3.4 IMEæ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®å³æ ¼æ€§
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `ImeController.swift:254-269`
- **å•é¡Œ**: éåº¦ã«å³æ ¼ãªIMEåˆ‡ã‚Šæ›¿ãˆæ¤œè¨¼
- **ä¿®æ­£æ–¹æ³•**: æŸ”è»Ÿæ€§ã®ã‚ã‚‹æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯

---

## ğŸ”§ ä¿®æ­£å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### çŸ­æœŸä¿®æ­£ï¼ˆ1-2é€±é–“ï¼‰

1. **ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾å¿œ**
   ```swift
   // ImeController.swift
   private func buildCacheSync() {
       guard let cfInputSources = TISCreateInputSourceList(nil, false) else { return }
       defer { CFRelease(cfInputSources) } // è¿½åŠ 
       // æ—¢å­˜å‡¦ç†...
   }
   ```

2. **é€šçŸ¥ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**
   ```swift
   // MenuBarApp.swift
   private var notificationObservers: [NSObjectProtocol] = []
   
   deinit {
       notificationObservers.forEach { 
           DistributedNotificationCenter.default().removeObserver($0) 
       }
   }
   ```

### ä¸­æœŸä¿®æ­£ï¼ˆ1-2ãƒ¶æœˆï¼‰

1. **ä¾å­˜é–¢ä¿‚æ³¨å…¥ã®å®Ÿè£…**
   ```swift
   protocol IMEControlling {
       func getCurrentInputSource() -> String
       func switchToSpecificIME(_ imeId: String)
   }
   
   class MenuBarApp {
       private let imeController: IMEControlling
       
       init(imeController: IMEControlling = ImeController()) {
           self.imeController = imeController
       }
   }
   ```

2. **éåŒæœŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   ```swift
   enum IMEResult<T> {
       case success(T)
       case failure(ModSwitchIMEError)
   }
   
   func switchToSpecificIME(_ imeId: String) async -> IMEResult<Void> {
       // å®Ÿè£…
   }
   ```

### é•·æœŸä¿®æ­£ï¼ˆ3-6ãƒ¶æœˆï¼‰

1. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å†è¨­è¨ˆ**
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   MenuBarApp    â”‚    â”‚  KeyEventHandler â”‚
   â”‚   (UI Only)     â”‚    â”‚  (Event Only)    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚        IMEManager                 â”‚
   â”‚    (Business Logic Only)          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

2. **çŠ¶æ…‹ç®¡ç†ã®çµ±ä¸€**
   ```swift
   @MainActor
   class AppState: ObservableObject {
       @Published var currentIME: String = ""
       @Published var isMonitoring: Bool = false
       @Published var hasPermission: Bool = false
   }
   ```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### å˜ä½“ãƒ†ã‚¹ãƒˆå¼·åŒ–

1. **Mockãƒ»Stubã®æ´»ç”¨**
   ```swift
   class MockImeController: IMEControlling {
       var switchCallCount = 0
       var currentIME = "com.apple.keylayout.ABC"
       
       func switchToSpecificIME(_ imeId: String) {
           switchCallCount += 1
           currentIME = imeId
       }
   }
   ```

2. **ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ**
   ```swift
   func testNoMemoryLeak() {
       weak var weakController: ImeController?
       autoreleasepool {
           let controller = ImeController()
           weakController = controller
       }
       XCTAssertNil(weakController)
   }
   ```

### çµ±åˆãƒ†ã‚¹ãƒˆå¼·åŒ–

1. **ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ**
2. **ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ãƒ†ã‚¹ãƒˆ**
3. **ã‚¨ãƒ©ãƒ¼å¾©æ—§ãƒ†ã‚¹ãƒˆ**

---

## ğŸ“ˆ é€²æ—è¿½è·¡

### ä¿®æ­£å®Œäº†é …ç›® âœ…

| æ—¥ä»˜ | é …ç›® | æ‹…å½“ | è©³ç´° |
|------|------|------|------|
| 2025-06-27 | ImeControlleré‡è¤‡ç”Ÿæˆ | Claude | ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³åŒ–å®Œäº† |
| 2025-06-27 | CoreFoundationãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ | Claude | takeRetainedValue()ä½¿ç”¨ |
| 2025-06-27 | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç«¶åˆçŠ¶æ…‹ | Claude | ç›´åˆ—ã‚­ãƒ¥ãƒ¼ã«å¤‰æ›´ |
| 2025-06-27 | ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ  | Claude | SingletonTests, MemoryManagementTestsè¿½åŠ  |
| 2025-06-27 | ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆä¿®æ­£ | Claude | MockableImeControllerã«ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°å®Ÿè£… |

### ä¿®æ­£äºˆå®šé …ç›® ğŸ“…

| å„ªå…ˆåº¦ | é …ç›® | äºˆå®šæ—¥ | æ‹…å½“ |
|--------|------|--------|------|
| é«˜ | CGEventTapã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é‡å‡¦ç† | TBD | TBD |
| é«˜ | é€šçŸ¥ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ã®ãƒªãƒ¼ã‚¯ | TBD | TBD |
| é«˜ | EventTapå†ä½œæˆã®ç«¶åˆ | TBD | TBD |

---

## ğŸ“ æ³¨æ„äº‹é …

1. **ä¿®æ­£é †åº**: ä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ã—ã€ä¸‹ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ä¿®æ­£
2. **ãƒ†ã‚¹ãƒˆ**: å„ä¿®æ­£å¾Œã«å›å¸°ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ä¿®æ­£å¾Œã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬ã‚’å®Ÿæ–½
4. **äº’æ›æ€§**: æ—¢å­˜è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã®äº’æ›æ€§ã‚’ç¶­æŒ

---

## ğŸ”„ ç¶™ç¶šçš„æ”¹å–„

1. **å®šæœŸç›£æŸ»**: æœˆæ¬¡ã§ã®ã‚³ãƒ¼ãƒ‰å“è³ªç›£æŸ»
2. **ãƒ¡ãƒˆãƒªã‚¯ã‚¹**: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã€å¿œç­”æ™‚é–“ã®ç¶™ç¶šçš„ç›£è¦–
3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: ã‚¨ãƒ©ãƒ¼å ±å‘Šã®ä½“ç³»çš„åˆ†æ

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´6æœˆ27æ—¥  
**ç›£æŸ»å®Ÿæ–½è€…**: Claude (Anthropic)  
**æ¬¡å›ç›£æŸ»äºˆå®š**: TBD