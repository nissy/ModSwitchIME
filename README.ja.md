# ModSwitchIME

<img src="https://github.com/user-attachments/assets/f603fcce-77fa-474b-8f8e-c9fc7a426005" width="128">

修飾キーでIMEを瞬時に切り替える - 多言語ユーザーのためのmacOSアプリ

## 概要

ModSwitchIMEは、修飾キー（Command、Shift、Control、Option）を単独で押すだけでIMEを瞬時に切り替えられるmacOSメニューバーアプリケーションです。

### こんな方におすすめ

- 🌐 **多言語開発者** - コードは英語、コメントは日本語で書く方
- 📝 **翻訳者・ライター** - 原文と翻訳文を頻繁に切り替える方
- 🎯 **シンプルで確実なIME切り替えを求める方**

## 機能

### 1. 修飾キーでのIME切り替え

<img width="612" src="https://github.com/user-attachments/assets/7b95ff17-bb5b-4242-8c4c-04f57dabfcbe" />

#### 8個の修飾キーすべてに個別のIMEを設定可能

- **左右のCommand** ⌘
- **左右のShift** ⇧
- **左右のControl** ⌃
- **左右のOption** ⌥

各キーにお好みのIMEを割り当てられます。例えば：
- 左Command → 英語
- 右Command → 日本語
- 左Shift → 中国語
- その他、システムに登録されているIMEなら何でも設定可能

#### 動作の仕組み
- **単独キー押下**: 修飾キーを単独で押して離す → 設定したIMEに切り替え
- **複数キー押下**: 複数の修飾キーを押す → 最後に押したキーのIMEに切り替え
- **通常のショートカット**: 修飾キー + 他のキー → 通常通り動作（Cmd+C、Cmd+Vなど）
- **左右の区別**: 左右の修飾キーを独立したキーとして扱う
- **即座に切り替え**: キーを離した瞬間に切り替え（遅延なし）

### 2. 高度なIME切り替え機能

#### 複数キー同時押し
複数の修飾キーにIMEが設定されている場合：
- 同時押し判定の際も最後に押したキーに設定されたIMEに切り替え
- 例：左Cmd（英語）+ 右Cmd（日本語）→ 日本語に切り替え

#### スマート検出
- 単独キー押下とキーコンビネーションを区別
- ショートカット使用時（Cmd+W、Ctrl+Tabなど）の誤切り替えを防止
- 既存のキーボードショートカットと共存するよう設計
- 注意：修飾キーイベントのみに基づく検出です

### 3. アイドル時自動切り替え

#### 設定項目
- **有効/無効**
- **アイドル検出時間**: 1〜300秒（1秒単位）
- **切り替え先IME**: 
  - デフォルト：英語（ABC）
  - カスタマイズ：システム有効化されたIMEなら何でも

#### 動作
- キーボード操作なしの時間をカウント
- 設定時間に達すると指定IMEに自動切り替え
- マウス操作は検出しません（キーボードのみ）
- キー入力で通常動作に復帰

### 4. リアルタイム設定更新

- ほとんどの設定は再起動なしで即座に反映
- リアルタイムで変更可能な設定：
  - 修飾キーへのIME割り当て
  - アイドル時自動切り替えのオン/オフ
  - アイドル時間の変更
  - 切り替え先IMEの選択
- 注意：一部のシステムレベルの変更はメニューバーアイコンのクリックが必要な場合があります

### 5. パフォーマンス特性

- **起動時間**: 高速なアプリケーション起動
- **IME切り替え速度**: 50ms重複防止付きの高速切り替え
- **CPU使用率**: アイドル時の低リソース使用
- **メモリ使用量**: 軽量なメモリフットプリント
- **バッテリー影響**: 最小限

### 6. 強化された安定性と回復機能

#### 自動システム回復
- **イベントタップヘルスモニタリング**: システムレベルのキー検出機能を監視
- **自動回復**: macOSがキー監視を無効化した場合（システムアップデート後など）に機能回復を試みる
- **重複防止**: 50msスロットリングで誤った重複切り替えを防止
- **アプリケーションフォーカス追跡**: アプリケーション切り替え時のIME状態変化を検出
- **バックグラウンド耐性**: システムアクティビティ中も安定動作するよう設計

#### 信頼性機能
- **自動回復**: ユーザー介入なしで機能回復を試みる
- **システム統合**: macOSアップデートと権限変更を適切に処理
- **パフォーマンス最適化**: 応答性を維持しながら冗長な操作を削減


## セキュリティとプライバシー

ModSwitchIMEはプライバシーとセキュリティを中核原則として設計されています：

- **プライバシーファースト設計**: ショートカットと単独修飾キーを区別するためにキー押下を検出しますが、テキスト内容は一切記録しません
- **データ収集なし**: すべての処理はお使いのMac上でローカルに実行されます
- **オープンソース**: 完全なソースコードを検査可能です
- **コード署名済み**: 公式リリースはDeveloper IDで署名され、Appleによって公証されています

📋 **[詳細なセキュリティポリシーを見る](https://github.com/nissy/ModSwitchIME/blob/main/SECURITY_POLICY.md)**

## インストール

### システム要件

- macOS 13.0 (Ventura) 以降
- アクセシビリティ権限が必要

### インストール手順

1. [Releases](https://github.com/nissy/ModSwitchIME/releases)から最新のDMGをダウンロード
2. **アップデート時**: まずModSwitchIMEを終了（🌐アイコン → Quit）
3. DMGをマウントし、ModSwitchIME.appをアプリケーションフォルダにドラッグ
4. 初回起動時にアクセシビリティ権限を付与

> **注意**: アップデート時は、必ず先にアプリを終了してください。「項目は使用中です」エラーを避けるため、これはmacOSのセキュリティ機能です。

## 使い方

### 基本設定

1. メニューバーの「🌐」アイコンをクリック
2. 「Preferences...」を選択
3. 各修飾キーに希望のIMEを割り当て

### 設定項目

#### 修飾キーの割り当て
- 8個の修飾キーそれぞれにIMEを割り当て
- デフォルト：自動割り当てなし（手動設定が必要）

#### 切り替え動作
- **即座に切り替え**: 修飾キーを離すと即座にIMEが切り替わります
- **遅延不要**: 他のツールと異なり、待ち時間は必要ありません
- **スマート検出**: 単独キー押下とショートカットを自動的に区別

#### アイドル時自動切り替え
- アイドル時間：1〜300秒
- ターゲット：任意のIMEを選択

## 他のIME切り替えアプリとの技術比較

### 実装アプローチ

ModSwitchIMEは直接IME切り替えのために**TISInputSource API**を使用し、他のアプリの多くは**キーイベントシミュレーション**を使用します：

| アプリ | 実装方式 | 長所 | 制限事項 |
|-----|---------|------|----------|
| **ModSwitchIME** | TISInputSource API（リトライ付き） | 直接IME制御、信頼性の高いCJK対応 | アクセシビリティ権限が必要 |
| **英かな (eisukana)** | CGEvent API + TIS | シンプル、軽量 | 主に英語⇔日本語 |
| **Karabiner-Elements** | IOKit HID傍受 | 高度にカスタマイズ可能、低レベル制御 | CJK言語切り替えに既知の問題 |
| **BetterTouchTool** | 自動化/外部ツール | 幅広いジェスチャー対応 | 間接的、ヘルパーツールが必要 |
| **Hammerspoon** | Luaスクリプティングブリッジ | 無限のカスタマイズ | プログラミング知識が必要 |

### 主な技術的優位性

#### 1. **直接IME制御**
- **ModSwitchIME**: 即座の切り替えのためにTISSelectInputSourceを使用
- **その他**: 多くはCmd+Spaceをシミュレートまたはキーコードを送信（間接的方法）

#### 2. **CJK言語の信頼性**
- **ModSwitchIME**: リトライロジックと検証機能により信頼性の高いCJK切り替えを実現
- **Karabiner-Elements**: CJK言語でのTISSelectInputSourceに関する既知の問題あり
- **その他**: macOS APIの制限を継承するか、回避策を使用

#### 3. **修飾キーサポート**
- **ModSwitchIME**: 8個すべての修飾キー（左右×4）を独立して設定可能
- **英かな**: 左右Commandのみ
- **その他**: 様々なキーコンビネーション、複雑な設定が必要な場合が多い

#### 4. **設定の複雑さ**
- **ModSwitchIME**: GUIベースの設定
- **Karabiner-Elements**: JSONファイル編集が必要
- **Hammerspoon**: Luaプログラミングが必要
- **その他**: アプリ固有のインターフェース

### ModSwitchIMEを選ぶ理由

**以下のニーズがある方に最適:**
1. **信頼性の高い多言語切り替え** - 特にCJK言語向け
2. **最大限の修飾キー柔軟性** - 8個の独立キー vs 他アプリの2〜4個
3. **高速切り替え** - 直接APIコール（50ms重複防止）
4. **シンプルな設定** - GUI vs JSON/プログラミング
5. **IME専用設計** - 汎用自動化ツールではなく専用設計

**技術的独自性:**
- 包括的なIME制御のために最新のTISInputSource APIを使用する唯一のアプリ
- 単独キーとコンビネーションの精密な修飾キー検出
- 信頼性の高いキー検出のための状態ベース実装

## ライセンス

MIT License